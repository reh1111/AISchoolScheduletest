import streamlit as st
from google import genai
from google.genai import types
import json
import pandas as pd
import io  # –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±—É—Ñ–µ—Ä–æ–º –¥–∞–Ω–Ω—ã—Ö (–Ω—É–∂–Ω–∞ –¥–ª—è Excel)

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---
api_key = "AIzaSyCQem2XhNLypEsOIN9zcbuwAcdwcSdeV9I"

# --- –ù–ê–°–¢–†–û–ô–ö–ò –°–¢–†–ê–ù–ò–¶–´ ---
st.set_page_config(page_title="AI –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ Pro", layout="wide", initial_sidebar_state="expanded")

st.title("üéì –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —à–∫–æ–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è Pro")
st.markdown("""
–≠—Ç–æ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –≤–µ—Ä—Å–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞. –ù–µ–π—Ä–æ—Å–µ—Ç—å —É—á–∏—Ç—ã–≤–∞–µ—Ç —É—á–∏—Ç–µ–ª–µ–π, –∫–∞–±–∏–Ω–µ—Ç—ã, 
—Å–º–µ–Ω—ã –∏ –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –Ω–µ–¥–µ–ª—é.
""")

# --- –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ (–í–í–û–î –î–ê–ù–ù–´–•) ---
with st.sidebar:
    st.header("‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—Ä–µ–º–µ–Ω–∏")
    days_of_week = st.multiselect(
        "–£—á–µ–±–Ω—ã–µ –¥–Ω–∏",
        ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞", "–°—É–±–±–æ—Ç–∞"],
        default=["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞"]
    )
    lessons_per_day = st.slider("–ú–∞–∫—Å. —É—Ä–æ–∫–æ–≤ –≤ –¥–µ–Ω—å", 4, 8, 6)

    st.header("üè´ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —à–∫–æ–ª—ã")
    classes_input = st.text_area("–ö–ª–∞—Å—Å—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)", "5–ê, 5–ë, 9–ê, 11–ë")

    # –°–ª–æ–∂–Ω—ã–π –≤–≤–æ–¥: –ü—Ä–µ–¥–º–µ—Ç—ã –∏ –£—á–∏—Ç–µ–ª—è
    st.subheader("üë®‚Äçüè´ –£—á–∏—Ç–µ–ª—è –∏ –ü—Ä–µ–¥–º–µ—Ç—ã")
    st.caption("–§–æ—Ä–º–∞—Ç: –§–∞–º–∏–ª–∏—è (–ü—Ä–µ–¥–º–µ—Ç)")
    teachers_input = st.text_area(
        "–°–ø–∏—Å–æ–∫ —É—á–∏—Ç–µ–ª–µ–π",
        "–ò–≤–∞–Ω–æ–≤–∞ (–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞), –ü–µ—Ç—Ä–æ–≤ (–ò—Å—Ç–æ—Ä–∏—è), –°–∏–¥–æ—Ä–æ–≤ (–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞), –°–º–∏—Ç–æ–≤–∞ (–ê–Ω–≥–ª–∏–π—Å–∫–∏–π), –ö—É–∑–Ω–µ—Ü–æ–≤ (–§–∏–∑–∏–∫–∞, –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞)"
    )

    # –ö–∞–±–∏–Ω–µ—Ç—ã
    st.subheader("üö™ –ö–∞–±–∏–Ω–µ—Ç—ã")
    rooms_input = st.text_area("–°–ø–∏—Å–æ–∫ –∫–∞–±–∏–Ω–µ—Ç–æ–≤",
                               "–ö–∞–±. 101 (–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞), –ö–∞–±. 202 (–ò—Å—Ç–æ—Ä–∏—è), –°–ø–æ—Ä—Ç–∑–∞–ª, –ö–∞–±. 303 (–§–∏–∑–∏–∫–∞), –ö–∞–±. 105 (–û–±—â–∏–π)")

# --- –û–°–ù–û–í–ù–ê–Ø –ß–ê–°–¢–¨ ---

col1, col2 = st.columns(2)

with col1:
    st.subheader("üìã –£—á–µ–±–Ω—ã–π –ø–ª–∞–Ω (–ù–∞–≥—Ä—É–∑–∫–∞)")
    curriculum = st.text_area(
        "–°–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –∫–∞–∫–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ –Ω—É–∂–Ω–æ –≤ –Ω–µ–¥–µ–ª—é?",
        "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞: 5 —á–∞—Å–æ–≤, –†—É—Å—Å–∫–∏–π: 4 —á–∞—Å–∞, –ò—Å—Ç–æ—Ä–∏—è: 2 —á–∞—Å–∞, –§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞: 2 —á–∞—Å–∞, –§–∏–∑–∏–∫–∞: 2 —á–∞—Å–∞, –ê–Ω–≥–ª–∏–π—Å–∫–∏–π: 3 —á–∞—Å–∞."
    )

with col2:
    st.subheader("‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è")
    constraints = st.text_area(
        "–°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞",
        "–£ 5–ê —Ñ–∏–∑–∫—É–ª—å—Ç—É—Ä–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å 1-–º —É—Ä–æ–∫–æ–º. –ò–≤–∞–Ω–æ–≤–æ–π –¥–∞—Ç—å –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–π –¥–µ–Ω—å –≤ —Å—Ä–µ–¥—É. 11–ë –≥–æ—Ç–æ–≤–∏—Ç—å –∫ –ï–ì–≠ (–±–æ–ª—å—à–µ —Ñ–∏–∑–∏–∫–∏)."
    )

generate_btn = st.button("üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ", type="primary", use_container_width=True)


# --- –§–£–ù–ö–¶–ò–ò ---

def generate_schedule(api_key, days, classes, teachers, rooms, curriculum, constraints, max_lessons):
    client = genai.Client(api_key=api_key)

    # –°–ª–æ–∂–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    prompt = f"""
    –¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏—Å–ø–µ—Ç—á–µ—Ä —à–∫–æ–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —à–∫–æ–ª—ã.

    ### –í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï:
    1. **–î–Ω–∏ –Ω–µ–¥–µ–ª–∏:** {', '.join(days)}
    2. **–ú–∞–∫—Å. —É—Ä–æ–∫–æ–≤ –≤ –¥–µ–Ω—å:** {max_lessons}
    3. **–ö–ª–∞—Å—Å—ã:** {classes}
    4. **–£—á–∏—Ç–µ–ª—è –∏ –ø—Ä–µ–¥–º–µ—Ç—ã:** {teachers}
    5. **–ö–∞–±–∏–Ω–µ—Ç—ã:** {rooms}
    6. **–£—á–µ–±–Ω—ã–π –ø–ª–∞–Ω (–Ω–∞–≥—Ä—É–∑–∫–∞):** {curriculum}
    7. **–ñ–µ—Å—Ç–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** {constraints}

    ### –ü–†–ê–í–ò–õ–ê:
    - –£—á–∏—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –≤–µ—Å—Ç–∏ –¥–≤–∞ —É—Ä–æ–∫–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
    - –ö–∞–±–∏–Ω–µ—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–Ω—è—Ç –¥–≤—É–º—è –∫–ª–∞—Å—Å–∞–º–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
    - –°–æ–±–ª—é–¥–∞–π –Ω–∞–≥—Ä—É–∑–∫—É –∏–∑ —É—á–µ–±–Ω–æ–≥–æ –ø–ª–∞–Ω–∞.
    - –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –ø—Ä–µ–¥–º–µ—Ç—ã —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ.

    ### –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (JSON):
    –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ Markdown —Ä–∞–∑–º–µ—Ç–∫–∏. –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
    {{
        "days": {{
            "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫": {{
                "5–ê": ["–£—Ä–æ–∫ 1 (–ö–∞–±)", "–£—Ä–æ–∫ 2 (–ö–∞–±)", ...],
                "9–ë": ["...", ...]
            }},
            ...
        }}
    }}
    –ï—Å–ª–∏ —É—Ä–æ–∫–∞ –Ω–µ—Ç (–æ–∫–Ω–æ –∏–ª–∏ –∫–æ–Ω–µ—Ü –∑–∞–Ω—è—Ç–∏–π), –ø–∏—à–∏ —Å—Ç—Ä–æ–∫—É "---".
    –í —è—á–µ–π–∫–µ –ø–∏—à–∏ "–ü—Ä–µ–¥–º–µ—Ç (–£—á–∏—Ç–µ–ª—å, –ö–∞–±–∏–Ω–µ—Ç)".
    """

    response = client.models.generate_content(
        model='gemini-2.0-flash',
        contents=prompt,
        config=types.GenerateContentConfig(
            response_mime_type='application/json'
        )
    )
    return response.text


# --- –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---

if generate_btn:
        with st.spinner(
                '‚è≥ –ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–±–∏–Ω–µ—Ç—ã –∏ —Å—Ç—Ä–æ–∏—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 30 —Å–µ–∫—É–Ω–¥.'):
            try:
                # –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                json_result = generate_schedule(
                    api_key, days_of_week, classes_input, teachers_input,
                    rooms_input, curriculum, constraints, lessons_per_day
                )

                data = json.loads(json_result)

                st.success("‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!")

                # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ —á–µ—Ä–µ–∑ Tabs
                schedule_data = data.get("days", {})

                if not schedule_data:
                    st.warning("–ü—Ä–∏—à–µ–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Ç–æ—á–Ω–∏—Ç—å –ø—Ä–æ–º–ø—Ç.")
                else:
                    # –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è
                    tabs = st.tabs(list(schedule_data.keys()))

                    for i, day_name in enumerate(schedule_data.keys()):
                        with tabs[i]:
                            day_schedule = schedule_data[day_name]

                            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ DataFrame –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã
                            # –ö–ª—é—á–∏ JSON (–∫–ª–∞—Å—Å—ã) —Å—Ç–∞–Ω—É—Ç –∫–æ–ª–æ–Ω–∫–∞–º–∏
                            df = pd.DataFrame(dict([(k, pd.Series(v)) for k, v in day_schedule.items()]))

                            # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å —É—Ä–æ–∫–æ–≤ (1, 2, 3...)
                            df.index = [f"–£—Ä–æ–∫ {x + 1}" for x in range(len(df))]

                            st.subheader(f"üìÖ {day_name}")
                            st.dataframe(df, use_container_width=True)

                            # –ö–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                            col_down1, col_down2 = st.columns([1, 1])

                            with col_down1:
                                # CSV
                                csv = df.to_csv().encode('utf-8')
                                st.download_button(
                                    label=f"üìÑ –°–∫–∞—á–∞—Ç—å CSV ({day_name})",
                                    data=csv,
                                    file_name=f'schedule_{day_name}.csv',
                                    mime='text/csv',
                                    key=f"dl_csv_{i}"
                                )

                            with col_down2:
                                # EXCEL
                                try:
                                    buffer = io.BytesIO()
                                    with pd.ExcelWriter(buffer, engine='xlsxwriter') as writer:
                                        df.to_excel(writer, sheet_name=day_name)

                                    st.download_button(
                                        label=f"üìä –°–∫–∞—á–∞—Ç—å Excel ({day_name})",
                                        data=buffer,
                                        file_name=f'schedule_{day_name}.xlsx',
                                        mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                                        key=f"dl_xlsx_{i}"
                                    )
                                except ModuleNotFoundError:
                                    st.warning("–î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è Excel —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞–∫–µ—Ç: pip install xlsxwriter")
                                except Exception as e:
                                    st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Excel: {e}")

            except json.JSONDecodeError:
                st.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
                with st.expander("–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—ã—Ä–æ–π –æ—Ç–≤–µ—Ç"):
                    st.text(json_result)
            except Exception as e:
                st.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")